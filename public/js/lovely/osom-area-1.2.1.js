/**
 * lovely.io 'osom-area' module v1.2.1
 *
 * Copyright (C) 2012 Nikolay Nemshilov
 */
Lovely("osom-area-1.2.1",["dom-1.2.0","ui-2.0.0"],function(a){var b=this,c={},d,Class,ContextMenu,e,f,Mirror,OsomArea,Painter,Selection,g,h,c,i,j,k,l;return h=this.Lovely.module("core"),d=this.Lovely.module("dom-1.2.0"),g=this.Lovely.module("ui-2.0.0"),i=h.ext,l=h.isString,k=h.isNumber,j=h.isArray,Class=h.Class,e=d.Element,f=d.Input,OsomArea=new Class(f,{include:h.Options,extend:{Options:{autoresize:!0,keepselection:!1,minLastWordSize:2}},mirror:null,selection:null,painter:null,menu:null,constructor:function OsomArea(a,b){var c=this;return l(a)&&(a=d(a)),a instanceof d.NodeList&&(a=a[0]),a instanceof e&&(a=a._),this.$super(a),this.mirror=new Mirror(this),this.selection=new Selection(this),this.menu=new ContextMenu(this),this.painter=new Painter(this),this.menu.on("pick",function(a){return c.tryComplete(a.link.text())}),this.setOptions(b),this.repaint()},select:function(a,b){return a==null?this.selection.offsets():b==null?this.selection.text(a):(this.selection.offsets(a,b),this)},autocomplete:function(a,b){return typeof a==="function"?this.startCompleteCalls(a):(this._requesting=!1,this.menu.tryShow(a,b),this)},paint:function(){return this.painter.highlight.apply(this.painter,arguments),this},repaint:function(){return this.mirror.resize(),this},value:function(){var a;return a=f.prototype.value.apply(this,arguments),this.repaint(),a},setClass:function(){return e.prototype.setClass.apply(this,arguments),this.repaint()},addClass:function(){return e.prototype.addClass.apply(this,arguments),this.repaint()},removeClass:function(){return e.prototype.removeClass.apply(this,arguments),this.repaint()},toggleClass:function(){return e.prototype.toggleClass.apply(this,arguments),this.repaint()},radioClass:function(){return e.prototype.radioClass.apply(this,arguments),this.repaint()},startCompleteCalls:function(a){var c=this;return this.on("keyup",function(d){var e,f;if((f=d.keyCode)===37||f===38||f===39||f===40||f===13||f===27||f===32||d.altKey||d.ctrlKey||d.metaKey)return;e=c._.value.substr(0,c.selection.offsets()[0]).split(/\s+/).pop();if(e.length>=c.options.minLastWordSize&&e!==c._prev_last_word&&!c._requesting)return c._prev_last_word=e,c._timeout&&b.clearTimeout(c._timeout),c._timeout=b.setTimeout(function(){c._requesting=!0,c.menu.hide();if(a.call(c,e)===!1)return c._requesting=!1},100)})},tryComplete:function(a){var b,c,d,e,f,g,h;d=this.selection.offsets(),f=this._.value,e=f.substr(0,d[0]),b=f.substr(d[1],f.length);if(this._last_word)e=e.substr(0,e.lastIndexOf(this._last_word));else for(c=g=h=a.length;h<=0?g<=0:g>=0;c=h<=0?++g:--g)if(e.substr(e.length-c,e.length)===a.substr(0,c)){e=e.substr(0,e.length-c);break}return this._.value=e+a+b,d=(e+a).length,this.selection.offsets(d,d),this}}),Mirror=new Class(e,{constructor:function Mirror(a){var b=this;return this.textarea=a.style({position:"relative"}),this.min_height=a._.offsetHeight,this.$super("div",{"class":"osom-area"}),this.anchor=(new e("div",{style:{position:"absolute",margin:"0",padding:"0",background:"none",border:"none"}})).append(this),a.on("focus",function(){return window.setTimeout(function(){return b.prepare()},1)}),a.on("keyup",function(){if(a.options.autoresize)return b.resize()}),a.on("blur",function(){return b.copyBackground()}),this.prepare().style({minHeight:this.min_height+"px"}),this._size_diff=this._.offsetHeight-a._.offsetHeight,this.style({minHeight:this.min_height-this._size_diff+"px"}),this},prepare:function(){try{this.anchor.insertTo(this.textarea,"before"),this.style(this.textarea.style("font-size,font-family,width,margin-top,margin-left,margin-right,margin-bottom,padding-top,padding-left,padding-right,padding-bottom,border-top-width,border-left-width,border-right-width,border-bottom-width")),this.position(this.textarea.position())}catch(a){}return this.copyBackground()},resize:function(){var a,b;return b=this.textarea._.value+"\n\n",this.textarea.painter.paint(b),a=this._.offsetHeight,a<this.min_height&&(a=this.min_height),this.textarea._.style.height=a-this._size_diff+"px",this},absolute:function(a){var b,c,d,e;return d=this.textarea._.value,this._.innerHTML=d.substr(0,a)+'<div class="cursor"></div>'+d.substr(a),c=this.position(),e=this.textarea.position(),b=this.first(".cursor").position(),this.resize(),{x:e.x+b.x-c.x,y:e.y+b.y-c.y}},copyBackground:function(){return this.style(this.textarea.style({background:""}).style("backgroundColor,backgroundImage,backgroundRepeat,backgroundPosition")),this.textarea.style({background:"transparent"}),this},reset:function(){return this._.innerHTML=this.textarea._.value,this}}),Selection=new Class({constructor:function Selection(a){return this.textarea=a.on({blur:function(){if(this.options.keepselection)return this.selection.save()},focus:function(){if(this.options.keepselection)return this.selection.restore()}}),this},offsets:function(a,b){var c,d;return d=this.textarea._,a==null?(a=d.selectionStart,b=d.selectionEnd):(a=parseInt(a)||0,b=parseInt(b)||0,b<a&&(c=a,a=b,b=c),c=d.value.length,a<0&&(a=0),b<0&&(b=0),a>c&&(a=c),b>c&&(b=c),d.setSelectionRange(a,b)),[a,b]},text:function(a){var b,c;return a!=null?(b=this.textarea._.value.indexOf(a),b===-1?c=b=0:c=b+a.length,this.offsets(c,b)):(c=this.offsets(),this.textarea._.value.substring(c[0],c[1]))},position:function(){return this.textarea.mirror.absolute(this.offsets()[0])},save:function(){return this._stash=this.offsets()},restore:function(){var a=this;if(this._stash)return window.setTimeout(function(){return a.offsets(a._stash[0],a._stash[1])},0)}}),ContextMenu=new Class(g.Menu,{constructor:function ContextMenu(a){return this.textarea=a,this.$super()},tryShow:function(a,b){var c;return j(a)&&(a="<a href='#'>"+a.join("</a><a href='#'>")+"</a>"),this.update(a),this.text()!==""?(c=this.textarea.value().substr(0,this.textarea.selection.offsets()[0]),c=c.lastIndexOf(b||this.textarea._prev_last_word),c=this.textarea.mirror.absolute(c),c.y+=3,c.x-=1,this.insertTo(this.textarea,"after"),this.position(c),this.show(),this.textarea._last_word=b||this.textarea._prev_last_word):this.hide(),this}}),Painter=new Class({constructor:function Painter(a){return this.textarea=a,this.markers=[],this.reset()},reset:function(){return this.textarea.mirror.reset(),this},highlight:function(a,b,c,d){return d||(this.markers=[]),this.markers.push([a,b,c]),this.paint()},paint:function(a){var b,c,d,e,f,g;a||(a=this.textarea._.value),b="",c=0,g=this.getMarkers(a);for(e=0,f=g.length;e<f;e++)d=g[e],b+=a.substring(c,d[0]),b+='<span class="highlight',d[2]&&(b+='" style="background:'+d[2]),b+='">'+a.substring(d[0],d[1])+"</span>",c=d[1];return b=d?b+a.substring(d[1]):a,this.textarea.mirror._.innerHTML=b,this},getMarkers:function(b){var c,d,e,f,g,h,i,j,m,n,o,p,q,r;if(this.markers.length===0)return[];b||(b=this.textarea._.value),g=[],q=this.markers;for(o=0,p=q.length;o<p;o++){r=q[o],d=r[0],m=r[1],n=r[2],i=0,e=0;if(k(d)&&k(m))g.push([d,m,n]);else if(d instanceof RegExp)while(h=b.substr(i).match(d))e=b.substr(i).indexOf(h[0]),g.push([i+=e,i+=h[0].length,m]);else if(l(d))while((e=b.substr(i).indexOf(d))!==-1)g.push([i+=e,i+=d.length,m])}g.sort(function(a,b){return a[0]-b[0]}),c=[],j=[0,0,a];while(f=g.shift()){if(f[0]<j[1]){if(f[2]===j[2]){j[1]=f[1];continue}j[1]=f[0]}c.push(f)}return c}}),c=i(OsomArea,{version:"1.2.1",Mirror:Mirror,Selection:Selection,ContextMenu:ContextMenu,Painter:Painter}),c}),function(){var a=document.createElement("style"),b=document.createTextNode("div.osom-area{position:absolute;border:0px solid transparent;overflow:none;color:transparent;white-space:pre-wrap;word-wrap:break-word}div.osom-area span.highlight{background:#ff0;border-radius:0.2em}div.osom-area div.cursor{display:inline-block;margin:0;padding:0;border:none;background:none;float:none;position:static}");a.type="text/css",document.getElementsByTagName("head")[0].appendChild(a),a.styleSheet?a.styleSheet.cssText=b.nodeValue:a.appendChild(b)}()